<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Shhh — Workspace</title>
<style>
  :root{
    --bg:#050507; --panel:#0b0c10; --muted:#9ca3af; --text:#d4d4d4;
    --accent:#3f803f; --accent-soft:#6bbf6b; --danger:#f97373;
  }
  *{box-sizing:border-box}
  body{
    margin:0; min-height:100vh; background:var(--bg); color:var(--text);
    font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
    display:flex; align-items:center; justify-content:center; overflow:hidden;
  }

  /* Matrix canvas */
  #matrix{position:fixed; inset:0; z-index:0; pointer-events:none; background:#020304}

  .wrap{width:100%; max-width:920px; padding:14px; position:relative; z-index:1}
  .panel{background:var(--panel); border-radius:10px; border:1px solid #1f2933; padding:14px; box-shadow:0 0 0 1px rgba(0,0,0,0.4)}

  .title{font-weight:600; color:var(--accent-soft); font-size:16px}
  .subtitle{font-size:12px; color:var(--muted); margin-top:4px}

  .row{display:flex; gap:8px; margin-top:10px}
  .row.column{flex-direction:column}
  input[type="text"], select, input[type="password"]{
    background:#020308; border:1px solid #262b32; color:var(--text);
    padding:8px 10px; border-radius:999px; font-size:14px; outline:none; width:100%;
  }
  button{border-radius:999px; padding:8px 14px; font-size:14px; cursor:pointer; border:1px solid var(--accent-soft); background:#111827; color:var(--text)}
  .muted{color:var(--muted); font-size:13px}

  #accessTop{display:flex; justify-content:space-between; align-items:flex-start}
  .field-label{font-size:11px; color:var(--muted); text-transform:uppercase; letter-spacing:.12em; margin-top:8px}
  .radio-group{display:flex; gap:10px; align-items:center}
  .suggest-pill{padding:4px 10px;border-radius:999px;border:1px solid #1f2933;background:#020308;color:var(--text);cursor:pointer;font-size:13px}

  /* policy list */
  .policy{margin-top:10px; border-top:1px solid #111827; padding-top:8px; color:var(--muted); font-size:13px}
  .policy-title{text-transform:uppercase; font-size:11px; color:#9ca3af; margin-bottom:6px}

  /* workspace */
  #workspace{display:none; margin-top:12px}
  #header{display:flex; justify-content:space-between; gap:10px; align-items:flex-start; font-size:13px; color:var(--muted)}
  #log{height:52vh; background:#050609; border-radius:8px; border:1px solid #1f2933; padding:8px; overflow:auto; font-family:monospace; font-size:13px; color:var(--accent-soft); white-space:pre-wrap}
  .line{margin:6px 0}
  .time{color:var(--muted); margin-right:6px}
  .user{color:var(--accent); font-weight:600; margin-right:8px}
  .text{color:var(--text)}

  /* input row */
  #sendRow{display:flex; gap:8px; margin-top:8px}

  /* admin bottom drawer */
  #adminDrawer{position:fixed; left:0; right:0; bottom:0; transform:translateY(120%); opacity:0; transition:transform .18s ease, opacity .18s; z-index:4; pointer-events:auto}
  #adminDrawer.visible{transform:translateY(0); opacity:1}
  #adminInner{max-width:920px;margin:0 auto;padding:10px 14px;background:rgba(7,9,13,0.94); border-top:1px solid #111827; display:flex; justify-content:space-between; align-items:center; gap:12px; border-radius:8px 8px 0 0}
  #adminText{display:flex;flex-direction:column}
  #adminTitle{font-size:11px; color:var(--muted); text-transform:uppercase; letter-spacing:.12em}
  #adminUser{font-weight:600; color:var(--accent-soft); font-size:14px; min-height:1em}
  .admin-btn{padding:6px 12px;border-radius:999px;border:1px solid #4ade80;background:transparent; font-size:13px; cursor:pointer}
  .admin-rej{border-color:#f97373}

  /* small toast */
  #toast{position:fixed; right:12px; top:12px; background:rgba(20,20,20,0.95); color:var(--text); padding:8px 12px;border-radius:8px;border:1px solid #222; z-index:10; display:none}

  /* light theme */
  body.light{--bg:#0b0c10; --panel:#111318; --muted:#9ca3af; --text:#e5e7eb; --accent:#5a9c5a; --accent-soft:#7acb7a}

  /* mask mode (double-ESC toggles) */
  body.mask{--accent:#b0b5c0; --accent-soft:#b0b5c0; --muted:#888; --text:#d0d0d0}
  body.mask #matrix{display:none}

  /* responsive */
  @media (max-width:640px){
    .row{flex-direction:column}
    #adminInner{flex-direction:column; align-items:flex-start}
    #log{height:46vh}
  }
</style>
</head>
<body>
<canvas id="matrix"></canvas>

<div id="toast"></div>

<div class="wrap">
  <div id="access" class="panel">
    <div id="accessTop">
      <div>
        <div class="title">SHHH — Workspace Access</div>
        <div class="subtitle">Private & public anonymous rooms — stealth-friendly</div>
      </div>
      <div class="muted">Transport: RTDB & client-only prototype</div>
    </div>

    <div class="field-label">Workspace type</div>
    <div class="radio-group">
      <label><input type="radio" name="type" value="public" checked> Public</label>
      <label><input type="radio" name="type" value="private"> Private</label>
    </div>

    <div id="publicBlock" class="row" style="margin-top:10px">
      <select id="publicSelect">
        <option value="pub-lobby">Public Lobby</option>
        <option value="pub-hyd">Hyderabad General</option>
        <option value="pub-movies">Movie Madness</option>
        <option value="pub-tech">Tech Corner</option>
        <option value="pub-random">Random</option>
      </select>
    </div>

    <div id="privateBlock" style="display:none">
      <div class="field-label">Private key (word-1234)</div>
      <input id="privateKey" placeholder="e.g. hyd-2313" type="text" />
      <div class="field-label">Join window (how long new people can use this invite)</div>
      <select id="joinWindow">
        <option value="10m">10 minutes</option>
        <option value="20m">20 minutes</option>
        <option value="1h">1 hour</option>
        <option value="8h">8 hours</option>
        <option value="forever">Until cleared</option>
      </select>

      <div class="field-label">Workspace name (optional)</div>
      <input id="privateName" placeholder="Team 9, Breakroom, etc" type="text" />

      <div class="field-label">Quick suggestions</div>
      <div id="sugs" style="display:flex;gap:8px;flex-wrap:wrap"></div>
    </div>

    <div class="field-label">Profile theme (codename pool)</div>
    <select id="themeSelect">
      <option value="generic">Generic</option>
      <option value="cartoon">Cartoon</option>
      <option value="anime">Anime</option>
      <option value="marvel">Marvel</option>
      <option value="dc">DC</option>
      <option value="hollywood">Hollywood</option>
      <option value="telugu">Telugu</option>
      <option value="mixed">Mixed</option>
    </select>

    <div class="row" style="margin-top:12px; align-items:center">
      <button id="startBtn">Start / Join</button>
      <div style="flex:1"></div>
      <div class="muted" id="err"></div>
    </div>

    <div class="policy">
      <div class="policy-title">Usage rules</div>
      <ul id="policyList">
        <li>Never use your real name or personal identifiers.</li>
        <li>No phone numbers, emails, or social handles.</li>
        <li>Messages are recorded and cannot be deleted by users.</li>
        <li>Explicit/harassing content triggers strikes and device block.</li>
        <li>Private keys are single-room invites; share carefully.</li>
        <li>Double-press <code>ESC</code> to enter Mask Mode (plain monitor view).</li>
      </ul>
    </div>
  </div>

  <div id="workspace" class="panel">
    <div id="header">
      <div>
        <div id="who" style="font-weight:600">USER: <span id="codename">—</span></div>
        <div class="muted" id="sessionInfo"></div>
      </div>
      <div style="text-align:right">
        <div id="roomInfo" class="muted">ROOM: <span id="roomLabel">—</span></div>
        <div id="themeBadge" class="muted">Theme: <span id="themeName">—</span></div>
      </div>
    </div>

    <div id="topic" class="muted" style="margin-top:8px">Topic: (none)</div>

    <div id="log"></div>

    <div style="margin-top:8px;display:flex;gap:8px;align-items:center">
      <input id="messageIn" placeholder="New entry..." type="text" style="flex:1;padding:8px;border-radius:999px;border:1px solid #262b32;background:#020308;color:var(--text)" />
      <button id="sendBtn">Send</button>
    </div>

    <!-- invite & admin controls area -->
    <div style="margin-top:8px;display:flex;gap:8px;align-items:center">
      <button id="copyInviteBtn" style="display:none">Copy invite link</button>
      <div id="inviteInfo" class="muted"></div>
    </div>
  </div>
</div>

<!-- Admin drawer -->
<div id="adminDrawer">
  <div id="adminInner">
    <div id="adminText">
      <div id="adminTitle">ACCESS REQUEST</div>
      <div class="muted">Incoming user:</div>
      <div id="adminUser">—</div>
    </div>
    <div style="display:flex;gap:8px">
      <button id="approveBtn" class="admin-btn">Approve</button>
      <button id="rejectBtn" class="admin-btn admin-rej">Reject</button>
    </div>
  </div>
</div>

<!-- Firebase SDK (compat not used, using modular v12) -->
<script type="module">
  // --- FIREBASE SETUP ---
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-analytics.js";
  import {
    getDatabase, ref, push, set, remove, onChildAdded, onValue,
    query, limitToLast, get, child, serverTimestamp
  } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-database.js";

  // <<-- Replace with your Firebase config if needed (this uses your earlier provided project) -->
  const firebaseConfig = {
    apiKey: "AIzaSyA-LAzB8_h4szHRqSil9ajdheZ4GvIXzIw",
    authDomain: "chat-rooms-ce467.firebaseapp.com",
    projectId: "chat-rooms-ce467",
    storageBucket: "chat-rooms-ce467.firebasestorage.app",
    messagingSenderId: "1066966492898",
    appId: "1:1066966492898:web:ad78474ad04296620260bb",
    measurementId: "G-TPP2H6T99P",
    databaseURL: "https://chat-rooms-ce467-default-rtdb.asia-southeast1.firebasedatabase.app"
  };

  const app = initializeApp(firebaseConfig);
  try { getAnalytics(app); } catch(e){ /* analytics optional */ }
  const db = getDatabase(app);

  // --- DOM ---
  const typeRadios = document.querySelectorAll("input[name='type']");
  const publicBlock = document.getElementById("publicBlock");
  const privateBlock = document.getElementById("privateBlock");
  const publicSelect = document.getElementById("publicSelect");
  const privateKey = document.getElementById("privateKey");
  const joinWindow = document.getElementById("joinWindow");
  const privateName = document.getElementById("privateName");
  const sugs = document.getElementById("sugs");
  const themeSelect = document.getElementById("themeSelect");
  const startBtn = document.getElementById("startBtn");
  const err = document.getElementById("err");
  const policyList = document.getElementById("policyList");

  const accessPanel = document.getElementById("access");
  const workspace = document.getElementById("workspace");
  const codenameEl = document.getElementById("codename");
  const sessionInfo = document.getElementById("sessionInfo");
  const roomLabel = document.getElementById("roomLabel");
  const themeName = document.getElementById("themeName");
  const topic = document.getElementById("topic");
  const logEl = document.getElementById("log");
  const messageIn = document.getElementById("messageIn");
  const sendBtn = document.getElementById("sendBtn");
  const copyInviteBtn = document.getElementById("copyInviteBtn");
  const inviteInfo = document.getElementById("inviteInfo");

  // admin drawer
  const adminDrawer = document.getElementById("adminDrawer");
  const adminUser = document.getElementById("adminUser");
  const approveBtn = document.getElementById("approveBtn");
  const rejectBtn = document.getElementById("rejectBtn");

  const toast = document.getElementById("toast");

  // matrix canvas
  const canvas = document.getElementById("matrix");
  const ctx = canvas.getContext("2d");
  let cols, drops, fontSize = 14, cw, ch;
  const matrixChars = "01ABCDEFGHIJKLMNOPQRSTUVWXYZ+-•";

  function resizeMatrix(){
    cw = canvas.width = window.innerWidth;
    ch = canvas.height = window.innerHeight;
    cols = Math.floor(cw / fontSize);
    drops = Array(cols).fill(0);
  }
  function drawMatrix(){
    ctx.fillStyle = "rgba(0,0,0,0.12)";
    ctx.fillRect(0,0,cw,ch);
    ctx.fillStyle = "rgba(60,120,60,0.32)";
    ctx.font = fontSize + "px monospace";
    for(let i=0;i<cols;i++){
      const chx = matrixChars[Math.floor(Math.random()*matrixChars.length)];
      const x = i*fontSize;
      const y = drops[i]*fontSize;
      ctx.fillText(chx, x, y);
      if(y > ch && Math.random()>0.985) drops[i] = 0; else drops[i]++;
    }
  }
  resizeMatrix(); setInterval(drawMatrix, 80); window.addEventListener("resize", resizeMatrix);

  // --- utilities ---
  function showToast(text, ms=2400){
    toast.textContent = text; toast.style.display = "block";
    setTimeout(()=>{ toast.style.display = "none"; }, ms);
  }
  function sanitizeKey(k){ return String(k||"").trim().toLowerCase(); }
  function now(){ return Date.now(); }

  // decrypt effect (used for rules/messages/popups)
  function decryptEffect(el, txt, delay=0){
    const full = String(txt||""); const pool = "01ABCDEFGHIJKLMNOPQRSTUVWXYZ#$%&@";
    let frame=0; const total = full.length + 8;
    el.textContent = "";
    const iv = setInterval(()=>{
      let out="";
      for(let i=0;i<full.length;i++){
        if(frame > i+6) out += full[i]; else out += pool[Math.floor(Math.random()*pool.length)];
      }
      el.textContent = out;
      frame++;
      if(frame > total){ clearInterval(iv); el.textContent = full; }
    }, 18 + delay);
  }

  // --- codename pools ---
  const POOLS = {
    cartoon:["Nobita","Shizuka","Doraemon","Shinchan","Tom","Jerry","Scooby","Velma","Dexter"],
    anime:["Naruto","Sasuke","Goku","Luffy","Zoro","Deku","Tanjiro","Nezuko","Levi"],
    marvel:["IronMan","Thor","Hulk","SpiderMan","Wanda","Vision","Loki","Rocket","Groot"],
    dc:["Batman","Superman","Flash","Aquaman","WonderWoman","Joker","HarleyQ"],
    hollywood:["Neo","Trinity","Frodo","Gandalf","JackSparrow","Ripley","Morpheus"],
    telugu:["Baahubali","Kattappa","PushpaRaj","RockyBhai","KomaramBheem","Gajjala","GabbarSingh","ArjunReddy"],
    generic:["Observer","Monitor","Watcher","Logger","Agent","NodeUser"]
  };
  const SUGGESTIONS = {
    generic:["Activity Stream","Ops Monitor","Quick Chat","Session Log","Desk Feed"],
    cartoon:["Anywhere Door","Gadget Room","Playground","Cartoon Corner"],
    anime:["Hidden Leaf","Akatsuki Base","Guild Hall","Spirit Room"],
    telugu:["Baahubali Fort","Pushpa Hub","Tollywood Desk","Rangasthalam"]
  };

  // pick random helper
  function pick(arr){ return arr[Math.floor(Math.random()*arr.length)]; }
  function generateCodename(theme){
    const pool = POOLS[theme] || POOLS.generic; return pick(pool) + (Math.floor(Math.random()*90)+10);
  }
  function getSavedCodename(theme){
    const key = "shhh_codename_"+theme;
    let c = localStorage.getItem(key);
    if(!c){ c = generateCodename(theme); localStorage.setItem(key, c); }
    return c;
  }

  // moderation checks
  const banned = ["nude","porn","sex","rape","fuck","dick","boob","xxx","nudity"];
  const socialHints = ["whatsapp","instagram","insta","telegram","snapchat","twitter","facebook","fb","dm me","pm me"];

  function containsBanned(t){
    const s = (t||"").toLowerCase();
    return banned.some(b=> s.includes(b));
  }
  function mentionsSocial(t){
    const s = (t||"").toLowerCase();
    return socialHints.some(h=> s.includes(h));
  }
  function looksLikeEmail(t){ return /[A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,}/i.test(t); }
  function looksLikePhone(t){ return (t||"").replace(/\D/g,"").length >= 10; }

  function isAllowedMessage(t){
    if(containsBanned(t) || mentionsSocial(t) || looksLikeEmail(t) || looksLikePhone(t)) return false;
    return true;
  }

  // local strikes
  function addStrike(){ let s=parseInt(localStorage.getItem("shhh_strikes")||"0",10); s++; localStorage.setItem("shhh_strikes",String(s)); if(s>=3) localStorage.setItem("shhh_banned","1"); updateStrikeUI(); }
  function updateStrikeUI(){ const s = parseInt(localStorage.getItem("shhh_strikes")||"0",10); /* could show in UI */ }
  function isBanned(){ return localStorage.getItem("shhh_banned")==="1"; }

  // animate rules on load
  (function animateRules(){
    const lis = policyList.querySelectorAll("li");
    lis.forEach((li,i)=>{ const text = li.textContent; li.textContent=""; const span = document.createElement("span"); li.appendChild(span); setTimeout(()=> decryptEffect(span,text,6), i*80); });
  })();

  // suggestions UI
  function updateSuggestions(){
    sugs.innerHTML="";
    const t = themeSelect.value||"generic";
    const arr = SUGGESTIONS[t] || SUGGESTIONS.generic;
    arr.slice(0,6).forEach(v=>{
      const d=document.createElement("div"); d.className="suggest-pill"; d.textContent=v; d.onclick=()=>{ privateName.value=v; }; sugs.appendChild(d);
    });
  }
  themeSelect.addEventListener("change", updateSuggestions);
  updateSuggestions();

  // toggle blocks
  function refreshTypeUI(){
    const type = document.querySelector("input[name='type']:checked").value;
    if(type==="public"){ publicBlock.style.display="flex"; privateBlock.style.display="none"; }
    else { publicBlock.style.display="none"; privateBlock.style.display="block"; }
  }
  typeRadios.forEach(r=> r.addEventListener("change", refreshTypeUI));
  refreshTypeUI();

  // state
  let currentUser=null, currentTheme=null, currentRoomId=null, currentRoomName=null;
  let messagesRef=null, presenceRef=null, metaRef=null, joinReqRef=null;
  let isCreator=false;
  let adminQueue=[], activeRequest=null;

  // helpers: compute joinUntil timestamps
  function getFutureMs(opt){
    const nowTs = now();
    if(opt==="10m") return nowTs + 10*60*1000;
    if(opt==="20m") return nowTs + 20*60*1000;
    if(opt==="1h") return nowTs + 60*60*1000;
    if(opt==="8h") return nowTs + 8*60*60*1000;
    return null;
  }

  // build invite link
  function buildInviteLink(key){
    const base = location.origin + location.pathname;
    return base + "?room=" + encodeURIComponent(key);
  }

  // auto-fill from URL (invite link)
  (function tryAutoFillFromURL(){
    const params = new URLSearchParams(location.search);
    const room = params.get("room");
    if(room){ privateKey.value = room; document.querySelector("input[name='type'][value='private']").checked = true; refreshTypeUI(); }
  })();

  // start/join session
  startBtn.addEventListener("click", async ()=>{
    err.textContent=""; if(isBanned()){ err.textContent="This device is blocked due to policy violations."; return; }
    currentTheme = themeSelect.value || "generic";
    currentUser = getSavedCodename(currentTheme);
    sessionInfo.textContent = "session:"+ (Math.floor(Math.random()*9000)+1000);
    codenameEl.textContent = currentUser;
    themeName.textContent = currentTheme;

    const type = document.querySelector("input[name='type']:checked").value;
    if(type==="public"){
      currentRoomId = publicSelect.value;
      currentRoomName = publicSelect.options[publicSelect.selectedIndex].text;
      isCreator=false;
      await openWorkspace();
      return;
    }

    // private flow
    const raw = sanitizeKey(privateKey.value);
    const keyRegex = /^[a-zA-Z]{2,12}-[0-9]{4}$/;
    if(!keyRegex.test(raw)){ err.textContent = "Private key must be like word-1234"; return; }
    const roomKey = raw;
    currentRoomId = "priv-"+roomKey;
    currentRoomName = (privateName.value.trim() || "Private Room");
    const jWin = joinWindow.value;

    // check meta
    metaRef = ref(db, "rooms/"+currentRoomId+"/meta");
    try{
      const snap = await get(metaRef);
      const nowTs = now();
      if(!snap.exists()){
        // create new room (creator)
        isCreator = true;
        const createdAt = nowTs;
        const joinUntil = getFutureMs(jWin);
        await set(metaRef, { roomName: currentRoomName, creator: currentUser, createdAt, joinUntil: joinUntil || null, expiryOption: jWin });
        showInviteUI(roomKey, joinUntil);
        openWorkspace();
        return;
      } else {
        const meta = snap.val() || {};
        // check joinUntil
        if(meta.joinUntil && nowTs > meta.joinUntil){
          err.textContent = "This invite has expired. Ask admin to create a new invite.";
          return;
        }
        // check creator match
        if(meta.creator === currentUser){
          isCreator = true;
          openWorkspace();
          return;
        }
        // check if already approved
        if(meta.approvedUsers && meta.approvedUsers[currentUser]){
          isCreator = false;
          openWorkspace();
          return;
        }
        // else: send join request
        joinReqRef = ref(db, "rooms/"+currentRoomId+"/joinRequests");
        const reqRef = await push(joinReqRef, { user: currentUser, time: now(), expireAt: meta.joinUntil || (now()+10*60*1000) });
        // log a system message for admin
        const msgRef = ref(db, "rooms/"+currentRoomId+"/messages");
        await push(msgRef, { user:"SYSTEM", text: "Join request from "+currentUser+". Admin can approve with /approve "+currentUser+".", time: now(), system:true });
        err.textContent = "Join request sent — waiting for admin approval.";
        // show time-left countdown for the join window if present
        if(meta.joinUntil){
          startJoinCountdown(meta.joinUntil);
        }
        return;
      }
    } catch(e){
      console.error(e); err.textContent = "Error accessing room meta.";
    }
  });

  // Show invite and copy
  function showInviteUI(roomKey, joinUntilTs){
    copyInviteBtn.style.display="inline-block";
    const link = buildInviteLink(roomKey);
    const untilText = joinUntilTs ? (" — valid until " + new Date(joinUntilTs).toLocaleTimeString()) : " — no expiry";
    inviteInfo.textContent = "Invite: " + link + untilText;
    copyInviteBtn.onclick = ()=>{
      navigator.clipboard?.writeText(link).then(()=> showToast("Invite copied")).catch(()=> showToast("Copy failed"));
    };
  }

  // open workspace: set listeners & UI
  async function openWorkspace(){
    accessPanel.style.display="none";
    workspace.style.display="block";
    roomLabel.textContent = currentRoomId;
    themeName.textContent = currentTheme;

    messagesRef = ref(db, "rooms/"+currentRoomId+"/messages");
    presenceRef = ref(db, "rooms/"+currentRoomId+"/presence");
    metaRef = ref(db, "rooms/"+currentRoomId+"/meta");
    joinReqRef = ref(db, "rooms/"+currentRoomId+"/joinRequests");

    // meta watcher
    onValue(metaRef, snap=>{
      const m = snap.val() || {};
      if(m.topic) topic.textContent = "Topic: " + m.topic;
      else topic.textContent = "Topic: (none)";
      if(m.roomName) { currentRoomName = m.roomName; roomLabel.textContent = currentRoomName + " ("+currentRoomId+")"; }
      // disable if expired
      if(m.joinUntil && now() > m.joinUntil){
        // join window expired — prevent new messages if room is private
        if(currentRoomId.startsWith("priv-") && !isCreator && !(m.approvedUsers && m.approvedUsers[currentUser])){
          messageIn.disabled = true; sendBtn.disabled = true;
        } else {
          messageIn.disabled = false; sendBtn.disabled = false;
        }
      } else {
        messageIn.disabled = false; sendBtn.disabled = false;
      }
    });

    // messages
    const q = query(messagesRef, limitToLast(200));
    onChildAdded(q, snap=>{
      appendMessage(snap.val());
    });

    // presence
    const pRef = push(presenceRef, { user: currentUser, joinedAt: now() });
    // onDisconnect cleanup not implemented in modular SDK without auth; acceptable for prototype

    // announce join
    await push(messagesRef, { user:"SYSTEM", text: currentUser+" joined.", time: now(), system:true });

    // admin: listen join requests (queue)
    if(isCreator){
      onChildAdded(joinReqRef, s=>{
        const v = s.val();
        if(!v || !v.user) return;
        adminQueue.push({ id:s.key, user:v.user, time:v.time || now(), expireAt:v.expireAt || null });
        if(!activeRequest) showNextRequest();
      });
    }

    // show invite UI if creator
    if(isCreator){
      // attempt to get meta for joinUntil display
      const snap = await get(metaRef);
      const meta = snap.exists() ? snap.val() : {};
      const roomKey = currentRoomId.replace(/^priv-/,"");
      showInviteUI(roomKey, meta.joinUntil || null);
    }
  }

  // append message with decrypt animation
  function appendMessage(msg){
    const timeStr = new Date(msg.time || now()).toLocaleTimeString([], {hour:"2-digit", minute:"2-digit"});
    const wrapper = document.createElement("div"); wrapper.className="line";
    const timeSpan = document.createElement("span"); timeSpan.className="time"; timeSpan.textContent = "["+timeStr+"] ";
    const userSpan = document.createElement("span"); userSpan.className="user"; userSpan.textContent = (msg.user||"SYSTEM").padEnd(12," ") + " :: ";
    const textSpan = document.createElement("span"); textSpan.className="text";
    wrapper.appendChild(timeSpan); wrapper.appendChild(userSpan); wrapper.appendChild(textSpan);
    logEl.appendChild(wrapper);
    logEl.scrollTop = logEl.scrollHeight;
    if(msg.system || msg.user==="SYSTEM"){ textSpan.textContent = msg.text || ""; wrapper.classList.add("system"); }
    else decryptEffect(textSpan, msg.text || "", 4);
    // small highlight
    wrapper.style.background = "rgba(80,120,80,0.02)";
    setTimeout(()=> wrapper.style.background = "transparent", 800);
  }

  // send message
  sendBtn.addEventListener("click", async ()=>{
    const txt = messageIn.value.trim();
    if(!txt) return;
    if(!isAllowedMessage(txt)){ alert("Message blocked (no personal/contact or explicit content)."); addStrike(); messageIn.value=""; return; }
    await push(messagesRef, { user: currentUser, text: txt, time: now() });
    messageIn.value = "";
  });
  messageIn.addEventListener("keydown", e=>{ if(e.key==="Enter"){ e.preventDefault(); sendBtn.click(); } });

  // admin drawer controls
  function showNextRequest(){
    if(adminQueue.length === 0){ activeRequest = null; adminDrawer.classList.remove("visible"); adminUser.textContent = ""; return; }
    activeRequest = adminQueue.shift();
    adminDrawer.classList.add("visible");
    adminUser.textContent = ""; decryptEffect(adminUser, activeRequest.user, 6);
    // auto-hide if not answered in 45s -> leave in queue but hide
    setTimeout(()=>{ if(activeRequest && adminDrawer.classList.contains("visible")) { adminDrawer.classList.remove("visible"); } }, 45000);
  }

  approveBtn.addEventListener("click", async ()=>{
    if(!activeRequest) return;
    const codename = activeRequest.user;
    // set approvedUsers/<codename> = true
    const approvedRef = ref(db, "rooms/"+currentRoomId+"/meta/approvedUsers/"+codename);
    await set(approvedRef, true);
    // remove the join request node
    const reqRef = ref(db, "rooms/"+currentRoomId+"/joinRequests/"+activeRequest.id);
    await remove(reqRef);
    // push a system message
    await push(messagesRef, { user:"SYSTEM", text: codename+" approved by admin.", time: now(), system:true });
    activeRequest = null;
    adminDrawer.classList.remove("visible");
    showNextRequest();
  });

  rejectBtn.addEventListener("click", async ()=>{
    if(!activeRequest) return;
    const codename = activeRequest.user;
    const reqRef = ref(db, "rooms/"+currentRoomId+"/joinRequests/"+activeRequest.id);
    await remove(reqRef);
    await push(messagesRef, { user:"SYSTEM", text: "Join request from "+codename+" was rejected by admin.", time: now(), system:true });
    activeRequest = null;
    adminDrawer.classList.remove("visible");
    showNextRequest();
  });

  // requester-side countdown to joinUntil
  let countdownTimer = null;
  function startJoinCountdown(joinUntilTs){
    if(!joinUntilTs) return;
    clearInterval(countdownTimer);
    countdownTimer = setInterval(()=>{
      const left = joinUntilTs - now();
      if(left <= 0){ clearInterval(countdownTimer); err.textContent = "Invite expired."; return; }
      const mm = Math.floor(left/60000); const ss = Math.floor((left%60000)/1000);
      err.textContent = "Waiting for admin. Invite valid for " + mm + "m " + ss + "s";
    }, 800);
  }

  // mask mode double ESC
  let lastEsc = 0;
  window.addEventListener("keydown", e=>{
    if(e.key === "Escape"){
      const t = Date.now();
      if(t - lastEsc < 400){
        document.body.classList.toggle("mask");
        document.title = document.body.classList.contains("mask") ? "System Monitor" : "Shhh — Workspace";
        showToast("Mask mode: " + (document.body.classList.contains("mask") ? "ON" : "OFF"), 1200);
      }
      lastEsc = t;
    }
  });

  // small UX: auto-clear pending UI when leaving
  window.addEventListener("beforeunload", ()=>{ /* presence cleanup would go here if auth enabled */ });

  // On load: parse URL and show
  (function onLoadInit(){
    const params = new URLSearchParams(location.search);
    const roomParam = params.get("room");
    if(roomParam){ privateKey.value = roomParam; document.querySelector("input[name='type'][value='private']").checked = true; refreshTypeUI(); }
  })();

  // quick test helpers: allow approve via /approve command from message input (optional)
  // (not implemented: commands parsing — could be added later)

  // END module
</script>
</body>
</html>
