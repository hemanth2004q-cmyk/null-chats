// Example: httpsCloudFunction approveUser
const functions = require("firebase-functions");
const admin = require("firebase-admin");
admin.initializeApp();

exports.approveUser = functions.https.onCall(async (data, context) => {
  const { roomId, codename } = data;
  if(!context.auth) throw new functions.https.HttpsError("unauthenticated","Sign-in required");
  const uid = context.auth.uid;
  const metaSnap = await admin.database().ref(`rooms/${roomId}/meta`).once('value');
  const meta = metaSnap.val();
  if(!meta) throw new functions.https.HttpsError("not-found","Room missing");
  if(meta.creatorUid !== uid) throw new functions.https.HttpsError("permission-denied","Not creator");
  await admin.database().ref(`rooms/${roomId}/meta/approvedUsers/${codename}`).set(true);
  await admin.database().ref(`rooms/${roomId}/joinRequests`).orderByChild('user').equalTo(codename).limitToFirst(1).once('value').then(snap=>{
    snap.forEach(c => c.ref.remove());
  });
  await admin.database().ref(`rooms/${roomId}/messages`).push({ user:"SYSTEM", text: `${codename} approved by admin.`, time: Date.now(), system:true });
  return { success:true };
});
